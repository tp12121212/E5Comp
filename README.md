# Microsoft Purview (E5 Compliance) Research Lab
This is a site for sharing technical testing results related to Microsoft Purview (E5 Compliance).

# Purview General
| Page | Contents |
| --- | ---- |
| [Personal Information Definition for Japan](https://github.com/YoshihiroIchinose/E5Comp/blob/main/SIT.md) | Examples of regular expression patterns for Japan, intended for use with M365, such as addresses and phone numbers. |
| [Handling Regular Expression Errors for Custom Sensitive Information](https://github.com/YoshihiroIchinose/E5Comp/blob/main/SIT_RegEx.md) | How to handle errors in regular expressions for custom sensitive information definitions. |
| [Differences in how file operation logs are displayed on devices for each service](https://github.com/YoshihiroIchinose/E5Comp/blob/main/MDE_DLP_IRM.MD) | Learn about the types of logs recorded by Defender for Endpoint, Endpoint DLP, and Insider Risk Management. |
| [Secure File Sharing Methods with External Parties](https://github.com/YoshihiroIchinose/E5Comp/blob/main/ExternalSharing.md) | This article summarizes methods for securely sharing files with external users, replacing PPAP. |
|[How to apply or exclude DLP on a library-by-library basis in SharePoint Online](https://github.com/YoshihiroIchinose/E5Comp/blob/main/DLPforSPOLibrary.md)|This article explains how to apply DLP on a library-by-library basis within a SharePoint Online site by setting the default retention label for the library as a DLP condition. |
|[Deleting specific logs from Microsoft Sentinel (Log Analytics)](https://github.com/YoshihiroIchinose/E5Comp/blob/main/SentinelDataPurge.md)|This article shares sample code that uses Azure Automation to delete only AIPHeartBeat logs from Log Analytics. |

# Sensitivity Label Related Articles
| Page | Contents |
| --- | ---- |
|[Sharing Azure Information Protection-Protected Files with External Users](https://github.com/YoshihiroIchinose/E5Comp/blob/main/AIP_FAQ.MD)| This article summarizes the requirements and precautions for sharing AIP-protected files with external users. |
|[Alert on Sensitivity Label Downgrade Operations with Sentinel](https://github.com/YoshihiroIchinose/E5Comp/blob/main/SentinelKusto.md)|This is a sample that uses Kusto queries to create an alert system that alerts you to multiple sensitivity label downgrades within a certain period of time, based on the sensitivity label operation logs imported using the Microsoft Purview Information Protection data connector. |
|[Using an alert policy to issue alerts based on operations recorded in the audit log](https://github.com/YoshihiroIchinose/E5Comp/blob/main/AlertPolicy.md)|This article explains how to set an alert policy via PowerShell to generate an alert when sensitivity labels are changed more than three times within an hour. |
|[Manipulating sensitivity labels via drag-and-drop on the desktop](https://github.com/YoshihiroIchinose/E5Comp/blob/main/LabelbyDD.md)|This example demonstrates how to apply sensitivity labels to multiple files or remove labels via drag-and-drop using the labeling and label removal PowerShell cmdlets included in the Purview Information Protection Client. |
|[Assigning Sensitivity Labels to SharePoint Online Files Using the Graph API](https://github.com/YoshihiroIchinose/E5Comp/blob/main/LabelingByGraph.md)|This is a sample that shows how to assign sensitivity labels to SharePoint Online files using the Graph API. |

# Audit Log Related Articles
| Page | Contents |
| --- | ---- |
| [Technical Information on Office 365 Audit Logs](https://github.com/YoshihiroIchinose/E5Comp/blob/main/Office365Audit.md)|This is a sample script that retrieves up to 50,000 Office 365 Audit logs in CSV format. It also covers parsing AuditData and converting CSV files to Excel files. |
| [Office 365 Audit Log RecordTypes and Retention](https://github.com/YoshihiroIchinose/E5Comp/blob/main/RecordTypes.md) | This article explains the types of logs recorded in the Office 365 Audit Log and how to set retention policies for those types. |
|[About Retrieving Audit Logs Using the Office 365 Management API](https://github.com/YoshihiroIchinose/E5Comp/blob/main/O365MgmtAPI.md) | This is a sample for retrieving Office 365 audit logs from PowerShell using the Office 365 Management API, which supports a larger scale than Search-UnifiedAuditLog. |
|[Using Azure Automation to Output Specific Operations from Office 365 Audit Logs in CSV Format and Upload to a SharePoint Online Site](https://github.com/YoshihiroIchinose/E5Comp/blob/main/UploadAuditLogtoSPO.md) | This script uses Azure Automation to output specific operations from Office 365 audit logs in CSV format and upload them to a SharePoint Online site. By periodically outputting logs to SharePoint Online in CSV format, you can incorporate them into Power BI reports, etc. |
|[Checking External Sharing Logs, Focused on B2B Collaboration](https://github.com/YoshihiroIchinose/E5Comp/blob/main/ExternalSharingLogs.md)| This script extracts external sharing logs, including guest users at the destination, in CSV format for three operations to understand external sharing destinations in B2B collaboration. |
|[Email Notification of External Sharing to Unauthorized Domains](https://github.com/YoshihiroIchinose/E5Comp/blob/main/ExternalSharingMonitoring.md)|This solution sample uses logs to detect sharing with external users outside of the authorized domains, taking into account information from the authorized domain list prepared in a SharePoint list, and uses Azure Automate/Power Automate/SharePoint Online lists to send a warning email to the user who performed the sharing operation. |
|[Email Notifications for Sensitivity Label Operations](https://github.com/YoshihiroIchinose/E5Comp/blob/main/LabelMonitoring.md)|This is a sample implementation of a solution that extracts operations such as downgrading sensitivity labels, deleting sensitivity labels, and decrypting data by changing sublabels from the audit logs of M365 Apps, SharePoint (Office for the web), and AIP add-ins. It then writes the logs of these operations to a SharePoint list using Azure Automate and uses Power Automate to send custom email notifications. |
| [Email Notifications for Endpoint DLP Operations](https://github.com/YoshihiroIchinose/E5Comp/blob/main/EDLPAlert.md) | This is a sample implementation of a solution that extracts FileCopiedToRemovableMedia and FileUploadedToCloud operations monitored by Endpoint DLP from the audit log, writes the logs of these operations to a SharePoint list using Azure Automate, and uses Power Automate to send custom email notifications. |

# General Operation Scripts
| Page | Contents |
| --- | ---- |
| [Unauthorized Teams Team Participation by Monitored Users](https://github.com/YoshihiroIchinose/E5Comp/blob/main/TeamsMembership.MD)| This sample script outputs any unauthorized Teams participation by monitored users belonging to a specific group, regardless of nesting. |
| [Finding Common Teams Teams for Groups with Conflicting Interests](https://github.com/YoshihiroIchinose/E5Comp/blob/main/ConflictsOfInterestInTeams.md) | As one way to monitor communication between groups with conflicting interests, this sample script lists members of specific Group A and Group B who coexist as members of unauthorized Teams teams, regardless of nesting. |
| [Listing Guest Users Set on Each SharePoint Online and OneDrive for Business Site (SPO Shell)](https://github.com/YoshihiroIchinose/E5Comp/blob/main/ExternalUsersFromSPO.md) | This sample script uses the SharePoint Online Management Shell from Azure Automation to retrieve a list of guest users on each SharePoint Online and OneDrive for Business site. The retrieved guest user list information is stored as a CSV file in the document library of a specific SharePoint Online site. |
| [Maintaining security groups based on service plan assignment status](https://github.com/YoshihiroIchinose/E5Comp/blob/main/LicensePowerShell.md) | This sample PowerShell script maintains security groups based on the assignment status of service plans, which are app-level licenses. |
| [Methods for managing credentials in PowerShell scripts for Office 365 management](https://github.com/YoshihiroIchinose/E5Comp/blob/main/SecretsInScripts.md) | When running various Office 365 management scripts unattended and periodically, you cannot enter credentials interactively, so you must store them in some form in advance. This article summarizes methods for storing and retrieving credentials that can be used for such scripts. |
|[Scripts related to Insider Risk Management's HR Connector](https://github.com/YoshihiroIchinose/E5Comp/blob/main/IRM_HR_Connector.md)|This article introduces a sample script that imports a CSV file uploaded to Azure Storage into the IRM HR Connector via an Azure Automation script, as well as a sample script that creates an email-enabled security group and maintains group membership based on the CSV file imported by the HR Connector. |
|[Posting to a Teams channel using the Graph API](https://github.com/YoshihiroIchinose/E5Comp/blob/main/PostTeamsMessage2.md)|This is a sample script that automates posting to a Teams channel chat using the Graph API implemented from PowerShell, which can be used for CC/DLP testing, etc. |
|[Posting to a Teams channel via the Microsoft Graph PowerShell SDK](https://github.com/YoshihiroIchinose/E5Comp/blob/main/PostTeamsMessage3.md)|This is a sample script that automates posting to a Teams channel chat using the Microsoft Graph PowerShell SDK, which can be used for CC/DLP testing, etc. |
|[Sample for Exporting Activity Explorer Logs to CSV](https://github.com/YoshihiroIchinose/E5Comp/blob/main/ActivityExplorerData.md)|This sample uses the newly added Export-ActivityExplorerData command to retrieve up to 30 days' worth of logs, up to 50,000 rows (5,000 rows x 10 times). |
|[Searching eDiscovery (Premium) Mailboxes Using the Graph API](https://github.com/YoshihiroIchinose/E5Comp/blob/main/eDiscoveryByGraph.md)|This example demonstrates how to use the Graph API to automate the following steps: create an eDiscovery (Premium) case, add a custodian (the user being investigated), specify the custodian's mailbox as the search target, register search keywords to find credit card number SITs in emails, create a review set, and update the review set with the search results. |

# Defender for Cloud Apps Related Articles
| Page | Contents |
| --- | ---- |
| [Listing Guest Users Set for Each SharePoint Online and OneDrive for Business Site (MDA)](https://github.com/YoshihiroIchinose/E5Comp/blob/main/MDA_API_External.md) | This sample script calls the Defender for Cloud Apps REST API from Azure Automation to retrieve externally shared files in SharePoint Online and OneDrive for Business, and then retrieves a list of guest users for each site based on their permission settings. The retrieved guest user list information is stored as a CSV file in the document library of a specific SharePoint Online site. |
| [Getting Defender for Cloud Apps file page information via API](https://github.com/YoshihiroIchinose/E5Comp/blob/main/MDA_API.md) | This article explains how to get Microsoft 365 Defender file page information using API access with PowerShell. |
| [Retrying label application governance actions in Defender for Cloud Apps](https://github.com/YoshihiroIchinose/E5Comp/blob/main/MDARetryLabeling.md) | This article uses API access with PowerShell to get information from the Microsoft 365 Defender governance log and retry applying a sensitivity label that has failed. |
| [Assigning Sensitivity Labels to Files in a Specific Folder Using the Defender for Cloud Apps API](https://github.com/YoshihiroIchinose/E5Comp/blob/main/MDALabeltoNonLabeldFiles.md) | This is a sample script that uses the Defender for Cloud Apps API to assign sensitivity labels to unlabeled files in a specific folder. While a similar effect can be achieved using governance actions in file policies, this script serves as an alternative to manual labeling in cases where governance actions are not performed due to an outage or other reason. |

# Communication Compliance Related Articles
| Page | Contents |
| --- | ---- |
| [Communication Compliance Term Sample](https://github.com/YoshihiroIchinose/E5Comp/blob/main/CC.md) | Sample red flag words defined for communication compliance testing. |
|[Downloading all content matching Communication Compliance policies in bulk](https://github.com/YoshihiroIchinose/E5Comp/blob/main/CCExport.md)|This is a sample script that automates the extraction of messages that match specific Communication Compliance policies. |
|[Communication Compliance Terminology Sample 2](https://github.com/YoshihiroIchinose/E5Comp/blob/main/CC2.md)|This is a sample of market manipulation and stock price manipulation-related words defined for Communication Compliance testing. |

# EDM Related Articles
| Page | Contents |
| --- | ---- |
|[Regarding Confidential Information and Exact Data Match Behavior](https://github.com/YoshihiroIchinose/E5Comp/blob/main/EDMMatching.MD)|This article summarizes the detection of confidential information and the current behavior of Exact Data Match in Japanese environments. |
|[Converting full-width alphanumeric characters and symbols to half-width for EDM data upload](https://github.com/YoshihiroIchinose/E5Comp/blob/main/EDM_Preprocess.md)|This is a sample PowerShell script that converts full-width alphanumeric characters and symbols in a CSV file to half-width for EDM data upload. |
| [Creating a keyword dictionary for Japanese address detection in EDM](https://github.com/YoshihiroIchinose/E5Comp/blob/main/AddressDictionayforEDM.md) | This explains how to use PowerShell to prepare address data provided by Japan Post for use in a keyword dictionary. |
| [Addressing word break discrepancies in word matching with a keyword dictionary](https://github.com/YoshihiroIchinose/E5Comp/blob/main/AddressDictionayforEDM2.md) | This explains the analysis and solution to the issue where the word break position differs depending on whether or not a page number is included in the main text when detecting using a keyword dictionary. |
| [Trimming addresses imported into EDM to match a keyword dictionary](https://github.com/YoshihiroIchinose/E5Comp/blob/main/AddressDictionayforEDM3.md) | This script uses a pre-created address keyword dictionary to trim address data to the prefecture, city, ward, town, village, and district names included in the keyword dictionary as pre-processing for EDM data. |